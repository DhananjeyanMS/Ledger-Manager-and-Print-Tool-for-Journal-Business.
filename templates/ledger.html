<!DOCTYPE html>
<html>
<head>
    <title>Add Ledger Entry</title>
</head>
<body style="font-family: Arial, sans-serif; display: flex; justify-content: center;">
    <form method="POST" style="width: 600px; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
        <h2 style="text-align: center;">Add Ledger Entry</h2>
<!-- Add this inside <form> just after <h2> -->
<script>
    const agentData = {{ agent_data | safe }};

    function populateAgentDetails() {
        const area = document.getElementById("area").value;
        const agent = agentData.find(a => a.area === area);

        if (agent) {
            document.getElementById("agent_name").value = agent.agent_Name;
            document.getElementById("agent_code").value = agent.agent_Code;
            document.getElementById("old_balance").value = agent.old_balance;
        } else {
            document.getElementById("agent_name").value = '';
            document.getElementById("agent_code").value = '';
            document.getElementById("old_balance").value = '';
        }

        calculateNewBalance();
    }
</script>

<!-- Area Dropdown and Agent Details -->
<label for="area"><strong>Area:</strong></label>
<select name="area" id="area" onchange="populateAgentDetails()" required>
    <option value="">-- Select Area --</option>
    {% for agent in agents %}
        <option value="{{ agent.area }}">{{ agent.area }}</option>
    {% endfor %}
</select><br><br>

<label for="agent_name"><strong>Agent:</strong></label>
<input type="text" name="agent_name" id="agent_name" readonly><br><br>

<label for="agent_code"><strong>Agent Code:</strong></label>
<input type="text" name="agent_code" id="agent_code" readonly><br><br>

<label for="old_balance"><strong>Old balance:</strong></label>
<input type="number" name="old_balance" step="0.01" id="old_balance" readonly><br><br>
<label for="entry_date"><strong>Entry date:</strong></label>
<input type="date" name="entry_date" required><br><br>


        <!-- Section: Receipt Entry -->
        <div style="margin-bottom: 40px;">
            <h3>Receipt Entry</h3>
            Receipt date <input type="date" name="receipt_date" required><br><br>
            Receipt Amount: <input type="number" name="receipt_Amount" step="0.01" id="receipt_Amount"><br><br>
            
        </div>

        <!-- Section: Credit Calculation -->
        <div style="margin-bottom: 40px;">
            <h3>Credit Calculation</h3>
            Credit date <input type="date" name="credit_date" required><br><br>
            <strong>Return Count</strong><br><br>
            Malligai Magal: <input type="number" name="ret_count_MM" id="ret_count_MM"><br><br>
            Nalla sapadu: <input type="number" name="ret_count_NS" id="ret_count_NS"><br><br>
            Suba varam: <input type="number" name="ret_count_SV" id="ret_count_SV"><br><br>
            Valli: <input type="number" name="ret_count_Valli" id="ret_count_Valli"><br><br>
            Vani: <input type="number" name="ret_count_Vani" id="ret_count_Vani"><br><br>
            Azhagi: <input type="number" name="ret_count_Azhagi" id="ret_count_Azhagi"><br><br>
            Arasi: <input type="number" name="ret_count_Arasi" id="ret_count_Arasi"><br><br>
            Thriller: <input type="number" name="ret_count_Thriller" id="ret_count_Thriller"><br><br>
            Extras: <input type="number" name="extras" step="0.01" id="extras"><br><br>
            Incentive: <input type="number" name="Incentive" step="0.01" id="Incentive"><br><br>
            Transport: <input type="number" name="Transport" step="0.01" id="Transport"><br><br>
            Postal Courier: <input type="number" name="Postal_Courier" step="0.01" id="Postal_Courier"><br><br>

            <span id="credit_loader" style="display:none;">Calculating...</span><br>
            Calculated Credit Amount: <input type="number" name="credit_Amount" step="0.01" id="credit_Amount" readonly><br><br>
        </div>

        <!-- Section: Bill & Balance -->
        <div>
            <h3>Bill & New Balance</h3>
            Bill date <input type="date" name="bill_date" required><br><br>
            <strong>Bill Count</strong><br><br>
            Malligai Magal: <input type="number" name="count_MM" id="count_MM"><br><br>
            Nalla sapadu: <input type="number" name="count_NS" id="count_NS"><br><br>
            Suba varam: <input type="number" name="count_SV" id="count_SV"><br><br>
            Valli: <input type="number" name="count_Valli" id="count_Valli"><br><br>
            Vani: <input type="number" name="count_Vani" id="count_Vani"><br><br>
            Azhagi: <input type="number" name="count_Azhagi" id="count_Azhagi"><br><br>
            Arasi: <input type="number" name="count_Arasi" id="count_Arasi"><br><br>
            Thriller: <input type="number" name="count_Thriller" id="count_Thriller"><br><br>
            

            <span id="bill_loader" style="display:none;">Calculating...</span><br>
            Calculated Bill Amount: <input type="number" name="bill_Amount" step="0.01" id="bill_Amount" readonly><br><br>
            New Balance Amount: <input type="number" name="new_balance" step="0.01" id="new_balance" readonly><br><br>
        </div>

        <div style="text-align: center;">
            <input type="submit" value="Add Entry">
        </div>
    </form>

    <script>
        const creditInputs = [
            'ret_count_MM', 'ret_count_NS', 'ret_count_SV', 'ret_count_Valli', 'ret_count_Vani',
            'ret_count_Azhagi', 'ret_count_Arasi', 'ret_count_Thriller', 'Incentive', 'Transport', 'Postal_Courier'
        ];

        const billInputs = [
            'count_MM', 'count_NS', 'count_SV', 'count_Valli', 'count_Vani',
            'count_Azhagi', 'count_Arasi', 'count_Thriller'
        ];

        creditInputs.concat(billInputs).forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                calculateCredit();
                calculateBill();
            });
        });

        document.getElementById("receipt_Amount").addEventListener('input', () => {
            calculateNewBalance();
        });

        function getVal(id) {
            return parseFloat(document.getElementById(id).value) || 0;
        }

        function calculateCredit() {
            document.getElementById("credit_loader").style.display = "inline";

            setTimeout(() => {
                let base40 = getVal('ret_count_MM') + getVal('ret_count_Valli') + getVal('ret_count_Vani') +
                             getVal('ret_count_Azhagi') + getVal('ret_count_Arasi') + getVal('ret_count_Thriller');
                let base50 = getVal('ret_count_NS') + getVal('ret_count_SV');

                let total = (base40 * 40) + (base50 * 50);
                let discount = total * 0.25;
                let credit = total - discount + getVal('Incentive') + getVal('Transport') + getVal('Postal_Courier') + getVal('extras');

                document.getElementById("credit_Amount").value = credit.toFixed(2);
                document.getElementById("credit_loader").style.display = "none";

                calculateNewBalance();
            }, 500);
        }

        function calculateBill() {
            document.getElementById("bill_loader").style.display = "inline";

            setTimeout(() => {
                let base40 = getVal('count_MM') + getVal('count_Valli') + getVal('count_Vani') +
                             getVal('count_Azhagi') + getVal('count_Arasi') + getVal('count_Thriller');
                let base50 = getVal('count_NS') + getVal('count_SV');

                let total = (base40 * 40) + (base50 * 50);
                let bill = total - (total * 0.25);

                document.getElementById("bill_Amount").value = bill.toFixed(2);
                document.getElementById("bill_loader").style.display = "none";

                calculateNewBalance();
            }, 500);
        }

        function calculateNewBalance() {
            let old_balance = getVal('old_balance');
            let credit = getVal('credit_Amount');
            let receipt = getVal('receipt_Amount');
            let bill = getVal('bill_Amount');

            let new_bal = old_balance - credit - receipt + bill;
            document.getElementById("new_balance").value = new_bal.toFixed(2);
        }
    </script>
</body>
</html>
