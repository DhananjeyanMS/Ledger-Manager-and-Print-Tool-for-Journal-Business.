{% extends 'base.html' %}
{% block title %}Add Receipt | Malligai Magal Ledger{% endblock %}
{% block content %}
<div class="container">
    <div class="toggle-group" style="display: flex; gap: 16px; margin-bottom: 24px;">
        <button id="addTab" class="toggle-btn active" type="button">Add Entry</button>
        <button id="editTab" class="toggle-btn" type="button">Edit Entry</button>
    </div>
    <div id="addSection">
        <h2>Add Receipt Entry</h2>
        <form method="POST" id="receiptForm">
            <label for="area">Area</label>
            <select name="area" id="area" required>
                <option value="">-- Select Area --</option>
                {% for agent in agents %}
                    <option value="{{ agent.area }}">{{ agent.area }}</option>
                {% endfor %}
            </select>
            <label for="agent_name">Agent</label>
            <input type="text" name="agent_name" id="agent_name" readonly>
            <label for="agent_code">Agent Code</label>
            <input type="text" name="agent_code" id="agent_code" readonly>
            <label for="old_balance">Old Balance</label>
            <input type="number" name="old_balance" step="0.01" id="old_balance" readonly>
            <label for="entry_date">Entry Date</label>
            <input type="date" name="entry_date" required>
            <label for="receipt_date">Receipt Date</label>
            <input type="date" name="receipt_date" required>
            <label for="receipt_Amount">Receipt Amount</label>
            <input type="number" name="receipt_Amount" step="0.01" id="receipt_Amount" required>
            <input type="submit" value="Add Receipt">
        </form>
        {% if message %}
            <div class="msg">{{ message }}</div>
        {% endif %}
    </div>
    <div id="editSection" style="display:none;">
        <h2>Edit Receipt Entries</h2>
        <div style="margin-bottom: 16px;">
            <label for="editArea">Area</label>
            <select id="editArea">
                <option value="">-- Select Area --</option>
                {% for agent in agents %}
                    <option value="{{ agent.area }}">{{ agent.area }}</option>
                {% endfor %}
            </select>
            <label for="editMonth">Month</label>
            <select id="editMonth"></select>
            <label for="editYear">Year</label>
            <select id="editYear"></select>
            <button id="loadReceipts" type="button">Load</button>
        </div>
        <table id="receiptTable" class="edit-table" style="width:100%; margin-bottom: 24px; display:none;">
            <thead>
                <tr>
                    <th>ID</th><th>Entry Date</th><th>Receipt Date</th><th>Amount</th><th>Agent</th><th>Edit</th><th>Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="editFormContainer"></div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const agentData = JSON.parse('{{ agent_data | tojson | safe }}');
// Toggle logic
const addTab = document.getElementById('addTab');
const editTab = document.getElementById('editTab');
const addSection = document.getElementById('addSection');
const editSection = document.getElementById('editSection');
addTab.onclick = function() {
    addTab.classList.add('active'); editTab.classList.remove('active');
    addSection.style.display = '';
    editSection.style.display = 'none';
};
editTab.onclick = function() {
    editTab.classList.add('active'); addTab.classList.remove('active');
    addSection.style.display = 'none';
    editSection.style.display = '';
};
// Populate agent details in Add form
if(document.getElementById('area')) {
    document.getElementById('area').addEventListener('change', function() {
        const area = this.value;
        const agent = agentData.find(a => a.area === area);
        if (agent) {
            document.getElementById('agent_name').value = agent.agent_Name;
            document.getElementById('agent_code').value = agent.agent_Code;
            document.getElementById('old_balance').value = agent.old_balance;
        } else {
            document.getElementById('agent_name').value = '';
            document.getElementById('agent_code').value = '';
            document.getElementById('old_balance').value = '';
        }
    });
}
// Edit tab: populate month/year dropdowns
function populateMonthYear() {
    const now = new Date();
    const monthSel = document.getElementById('editMonth');
    const yearSel = document.getElementById('editYear');
    monthSel.innerHTML = '';
    yearSel.innerHTML = '';
    for(let m=1; m<=12; m++) {
        const opt = document.createElement('option');
        opt.value = m; opt.text = m;
        if(m === now.getMonth()+1) opt.selected = true;
        monthSel.appendChild(opt);
    }
    for(let y=now.getFullYear()-2; y<=now.getFullYear(); y++) {
        const opt = document.createElement('option');
        opt.value = y; opt.text = y;
        if(y === now.getFullYear()) opt.selected = true;
        yearSel.appendChild(opt);
    }
}
populateMonthYear();
// Load receipts for edit
const loadBtn = document.getElementById('loadReceipts');
loadBtn.onclick = function() {
    const area = document.getElementById('editArea').value;
    const month = document.getElementById('editMonth').value;
    const year = document.getElementById('editYear').value;
    if(!area || !month || !year) return;
    fetch(`/list_receipts?area=${area}&month=${month}&year=${year}`)
        .then(r => r.json())
        .then(data => {
            const table = document.getElementById('receiptTable');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            if(data.length === 0) { table.style.display = 'none'; return; }
            table.style.display = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.id}</td><td>${row.entry_date}</td><td>${row.receipt_date}</td><td>${row.receipt_Amount}</td><td>${row.agent_name}</td>` +
                    `<td><button ${!row.editable ? 'disabled title="Locked by bill"' : ''} onclick="editReceipt(${row.id})">Edit</button></td>` +
                    `<td><button ${!row.deletable ? 'disabled title="Locked by bill"' : ''} onclick="deleteReceipt(${row.id})">Delete</button></td>`;
                tbody.appendChild(tr);
            });
        });
};
// Edit receipt logic
window.editReceipt = function(id) {
    fetch(`/edit_receipt/${id}`)
        .then(r => r.json())
        .then(data => {
            if(!data.editable) return alert('Cannot edit: Bill already exists for this agent/area/month.');
            const container = document.getElementById('editFormContainer');
            container.innerHTML = `<form id="editReceiptForm">
                <label>Entry Date</label><input type="date" name="entry_date" value="${data.entry_date}" required>
                <label>Receipt Date</label><input type="date" name="receipt_date" value="${data.receipt_date}" required>
                <label>Receipt Amount</label><input type="number" name="receipt_Amount" step="0.01" value="${data.receipt_Amount}" required>
                <button type="submit">Update</button>
            </form>`;
            document.getElementById('editReceiptForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch(`/edit_receipt/${id}`, {method:'POST', body:formData})
                    .then(r => r.json())
                    .then(resp => {
                        if(resp.success) {
                            alert('Updated successfully!');
                            loadBtn.onclick();
                            container.innerHTML = '';
                        }
                    });
            };
        });
};
// Delete receipt logic
window.deleteReceipt = function(id) {
    if(!confirm('Are you sure you want to delete this receipt?')) return;
    fetch(`/delete_receipt/${id}`, {method:'POST'})
        .then(r => r.json())
        .then(resp => {
            if(resp.success) {
                alert('Deleted successfully!');
                loadBtn.onclick();
            } else {
                alert(resp.error || 'Delete failed.');
            }
        });
};
</script>
{% if success %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        showSuccessModal('Receipt entry added successfully!', '/', '/add_receipt');
    });
</script>
{% endif %}
{% endblock %} 